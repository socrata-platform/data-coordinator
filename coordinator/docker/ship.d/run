#!/bin/sh
set -ev

/bin/env_parse ${SERVER_CONFIG}.j2

su socrata -c '/usr/bin/java \
    -Dconfig.file=${SERVER_CONFIG} \
    -jar $SERVER_ARTIFACT \
    com.socrata.datacoordinator.primary.MigrateSchema migrate \
    '

JMX_HOST_PORT=PORT_${JMX_PORT}

echo JMX ${JMX_HOST_PORT} -> ${JMX_PORT}

exec su socrata -c '/usr/bin/java \
    -Xmx${JAVA_XMX} \
    -Xms${JAVA_XMX} \
    -Dconfig.file=${SERVER_CONFIG} \
    -Djava.net.preferIPv4Stack=true \
    -Dcom.sun.management.jmxremote.port=${JMX_HOST_PORT} \
    -Dcom.sun.management.jmxremote.rmi.port=${JMX_HOST_PORT} \
    -Dcom.sun.management.jmxremote.ssl=false \
    -Dcom.sun.management.jmxremote.authenticate=false \
    -Djava.rmi.server.hostname=${ARK_HOST:-localhost} \
    -XX:MaxMetaspaceSize=${JAVA_MAX_METASPACE} \
    -jar $SERVER_ARTIFACT \
    com.socrata.datacoordinator.service.Main \
    '
